<?php
    namespace Application\Controller;
    
    use Application\Entity\Incident as IncidentEntity;
    use Zend\Mvc\Controller\AbstractActionController;
    use Zend\View\Model\ViewModel;
    use Zend\View\Model\JsonModel;
    
    /**
     * ResourceController
     *
     * @author
     *
     * @version
     *
     */
    class ResourceController extends AbstractActionController
    {
        private $resourceMapper;
        
        private $incidentMapper;
        
        public function __construct($resourceMapper, $incidentMapper)
        {
        	$this->resourceMapper = $resourceMapper;
        	$this->incidentMapper = $incidentMapper;
        }
        
        public function indexAction () {
            /*
             * TODO Define an index action should it become
             * necessary.
             * 
             * The route /resources redirects to this! 
             */
            return new ViewModel(array(
        	   'hierarchies' => $this->resourceMapper->fetchAllHierarchies()
            ));
        }
        
        /**
         * Return bookings as JSON response for API use
         */
        public function containmentAction ()
        {            
            return new JsonModel($this->resourceMapper->fetchAllContainments());
        }
        
        public function containmentByIdAction ()
        {
            $id = $this->getEvent()->getRouteMatch()->getParam('id');
            
        	return new JsonModel($this->resourceMapper->fetchContainmentsById($id));
        }
        
        public function resourcesAction ()
        {
            /*
             * Logging here for demonstartion only
             * TODO remove this later...
             */
            $incident = new IncidentEntity();
            $incident->setdescription('A user opened the Resource Editor');
            $incident->setclass(0);
            $this->incidentMapper->insert($incident);
            
            $hierarchyId = $this->getEvent()->getRouteMatch()->getParam('id');
            
        	return new ViewModel(array(
        		'hierarchyId' => $hierarchyId
        	));
        }
        
        public function addResourcesAction() {
            if ($this->getRequest()->isPost()) {
		/*
		 * TODO Validate?
		 */
                $hierarchyid = $this->getEvent()->getRouteMatch()->getParam('hierarchyid');
                $parentId = $this->getEvent()->getRouteMatch()->getParam('parentId');
                $resourceName = $this->params()->fromPost('resourceName');
                $resourceDescription = $this->params()->fromPost('resourceDescription');
                $resourceType = $this->params()->fromPost('resourceType');
                $bookable = $this->params()->fromPost('bookable');
                
                /**
                 * TODO
                 *      - Validate POST data
                 *        (http://stackoverflow.com/questions/458299/handling-input-with-the-zend-framework-post-get-etc#answer-458312)
                 *      - Deciede whether it is a room or equipment
                 *      - Insert data to the appropriate tables (ressources + rooms/equipments)
                 *      - Return the ID generated by MySQL to the JSON-model (replace 42 below)
                 */
                
                return new JsonModel(array(
			'resourceid' => 42,
			'success' => true
		));
            }
        }

        public function deleteResourceAction() {
            if ($this->getRequest()->isPost()) {
		/*
		 * TODO Validate?
		 */
                $hierarchyid = $this->getEvent()->getRouteMatch()->getParam('hierarchyid');
                $id = $this->getEvent()->getRouteMatch()->getParam('id');

		// TODO

		/*
		 * TODO return true/false
		 */
                return new JsonModel(array(
			'success' => true
		));
            }
        }
        
        public function updateResourceAction() {
		/*
		 * TODO Validate?
		 */
		if ($this->getRequest()->isPost()) {
		        $hierarchyid = $this->getEvent()->getRouteMatch()->getParam('hierarchyid');
		        $id = $this->getEvent()->getRouteMatch()->getParam('id');
		        $parentId = $this->getEvent()->getRouteMatch()->getParam('parentId');
		}

		// TODO

		/*
		 * TODO return true/false
		 */
                return new JsonModel(array(
			'success' => true
		));
        }
    }
?>
